import{j as e,r as V,K as z,m as H,L as K,$ as P,S as D}from"./app-DD1_j264.js";import{a as Q,c as A,b as G,B as j}from"./createLucideIcon-CJXjctMu.js";import{B as m}from"./badge-PeB8ie60.js";import{C as S,a as T,b as q,d as R,c as W}from"./card-DMpxeHKD.js";import{C as X}from"./checkbox-CmdZUS2u.js";import{L as c}from"./label-D4qny3wm.js";import{T as Y,a as Z,b as O,c as n,d as ee,e as l}from"./table-Bx2kdRqw.js";import{T as se}from"./textarea-3mhvGArJ.js";import{A as te,F as re,t as x}from"./app-layout-BjO8UPhY.js";import{U as ie}from"./user-DbbLjyYx.js";import{T as p}from"./triangle-alert-BbcsabZN.js";import{P as ae}from"./pill-BS0WEZWH.js";import"./index-CR58GS18.js";import"./index-Db2yqOI4.js";import"./index-D6cg2Mm3.js";import"./app-logo-DcjKhG5i.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],le=Q("CirclePlus",ne),de=G("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-background text-foreground",destructive:"text-destructive-foreground [&>svg]:text-current *:data-[slot=alert-description]:text-destructive-foreground/80"}},defaultVariants:{variant:"default"}});function y({className:r,variant:d,...a}){return e.jsx("div",{"data-slot":"alert",role:"alert",className:A(de({variant:d}),r),...a})}function _({className:r,...d}){return e.jsx("div",{"data-slot":"alert-description",className:A("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",r),...d})}function Ce({prescription:r,customerAllergies:d}){const[a,F]=V.useState([]),{props:g}=z(),b=(g==null?void 0:g.flash)||{},w=b.allergy_alerts||[],I=!!b.requires_allergy_override,{data:h,setData:u,processing:f,errors:v}=H({prescription_id:r.id,items_json:"[]",notes:"",override_allergy:0}),C=s=>{var t;return(t=s.medication)!=null&&t.active_ingredients?s.medication.active_ingredients.some(i=>d.some(o=>o.active_ingredient_id===i)):!1},L=s=>{const t=C(s),i=s.repeats_remaining>0,o=s.medication.quantity_on_hand>=s.quantity;return!t&&i&&o},$=s=>{F(t=>t.includes(s)?t.filter(i=>i!==s):[...t,s])},B=()=>r.items.filter(s=>a.includes(s.id)).reduce((s,t)=>{const i=Number(t.medication.current_sale_price)||0;return s+i*t.quantity},0),N=()=>a.map(s=>{var t;return{item_id:s,quantity:((t=r.items.find(i=>i.id===s))==null?void 0:t.quantity)||1}}),E=()=>{if(a.length===0){x.error("Please select at least one item to dispense.");return}u("items_json",JSON.stringify(N())),u("override_allergy",0),D.post(route("pharmacist.prescriptions.dispense.store"),{prescription_id:h.prescription_id,items_json:JSON.stringify(N()),notes:h.notes,override_allergy:0},{onSuccess:()=>{x.success("Prescription dispensed successfully!")},onError:s=>{console.error("Dispense errors:",s),x.error("Failed to dispense prescription. Please check for errors.")}})},J=()=>{if(a.length===0){x.error("No items selected to dispense.");return}const s=N();u("items_json",JSON.stringify(s)),u("override_allergy",1),D.post(route("pharmacist.prescriptions.dispense.store"),{prescription_id:h.prescription_id,items_json:JSON.stringify(s),notes:h.notes,override_allergy:1},{preserveScroll:!0,onSuccess:()=>{x.success("Dispensed with allergy override.")},onError:()=>{x.error("Override dispense failed.")}})},M=[{title:"Prescriptions",href:route("pharmacist.prescriptions.index")},{title:"Dispense",href:route("pharmacist.prescriptions.dispense")},{title:`Prescription #${r.id}`,href:route("pharmacist.prescriptions.dispense.show",r.id)}];return e.jsxs(te,{breadcrumbs:M,children:[e.jsx(K,{title:`Dispense Prescription ${r.id}`}),e.jsxs("div",{className:"flex h-full flex-1 flex-col gap-6 p-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("h1",{className:"text-2xl font-semibold tracking-tight",children:["Dispense Prescription #",r.id]}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Review details and select items to dispense."})]}),e.jsxs(S,{className:"rounded-none",children:[e.jsx(T,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),"Patient & Prescription Information"]})}),e.jsxs(R,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(c,{className:"text-muted-foreground text-sm font-medium",children:"Patient Name"}),e.jsxs("p",{className:"text-lg font-semibold",children:[r.user.name," ",r.user.surname]})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-muted-foreground text-sm font-medium",children:"Patient ID"}),e.jsx("p",{className:"text-lg",children:r.patient_id_number})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-muted-foreground text-sm font-medium",children:"Doctor"}),e.jsxs("p",{className:"text-lg",children:[r.doctor.name," ",r.doctor.surname]})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-muted-foreground text-sm font-medium",children:"Prescription Name"}),e.jsx("p",{className:"text-lg",children:r.name})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-muted-foreground text-sm font-medium",children:"Date Created"}),e.jsx("p",{className:"text-lg",children:new Date(r.created_at).toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-muted-foreground text-sm font-medium",children:"Repeats"}),e.jsxs("p",{className:"text-lg",children:[r.repeats_used," of ",r.repeats_total," used"]})]})]}),r.file_path&&e.jsxs("div",{className:"bg-muted mt-4 rounded-lg p-3",children:[e.jsxs(c,{className:"text-muted-foreground flex items-center gap-2 text-sm font-medium",children:[e.jsx(re,{className:"h-4 w-4"}),"Prescription File"]}),e.jsx(j,{variant:"link",className:"h-auto p-0",asChild:!0,children:e.jsx("a",{href:`/storage/${r.file_path}`,target:"_blank",rel:"noopener noreferrer",children:"View Uploaded PDF"})})]})]})]}),d.length>0&&e.jsxs(y,{className:"mb-6",children:[e.jsx(p,{className:"h-4 w-4"}),e.jsxs(_,{children:[e.jsxs("strong",{children:["Patient has ",d.length," known allergies:"]}),e.jsx("div",{className:"mt-1",children:d.map(s=>e.jsx(m,{variant:"outline",className:"mr-1 mb-1",children:s.active_ingredient_name},s.id))})]})]}),e.jsxs(S,{className:"rounded-none",children:[e.jsxs(T,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5"}),"Prescribed Medications"]}),e.jsx(W,{children:"Select the items you want to dispense. Only items with remaining repeats and sufficient stock can be dispensed."})]}),e.jsxs(R,{children:[w.length>0&&e.jsxs(y,{className:"mb-4 border-red-300 bg-red-50",children:[e.jsx(p,{className:"h-4 w-4"}),e.jsxs(_,{children:[e.jsx("strong",{className:"mb-2 block",children:"Allergy Conflict Detected"}),e.jsx("ul",{className:"mb-3 list-inside list-disc space-y-1 text-sm",children:w.map((s,t)=>e.jsx("li",{children:s},t))}),I&&e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(j,{variant:"destructive",type:"button",onClick:J,disabled:f,children:"Proceed Anyway (Override)"}),e.jsx(j,{variant:"outline",type:"button",onClick:()=>x.info("Review medication selection or consult prescriber."),children:"Cancel"})]})]})]}),e.jsx("div",{className:"overflow-x-auto border-y",children:e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(O,{children:[e.jsx(n,{className:"w-12",children:"Dispense"}),e.jsx(n,{children:"Medication"}),e.jsx(n,{children:"Instructions"}),e.jsx(n,{children:"Quantity"}),e.jsx(n,{children:"Repeats Left"}),e.jsx(n,{children:"Stock Available"}),e.jsx(n,{children:"Unit Price"}),e.jsx(n,{children:"Total"}),e.jsx(n,{children:"Status"})]})}),e.jsx(ee,{children:r.items.map(s=>{const t=C(s),i=L(s),o=s.quantity,k=Number(s.medication.current_sale_price)||0,U=k*o;return e.jsxs(O,{className:t?"bg-red-50":"",children:[e.jsx(l,{children:e.jsx(X,{checked:a.includes(s.id),onCheckedChange:()=>$(s.id),disabled:!i})}),e.jsxs(l,{children:[e.jsx("div",{className:"font-medium",children:s.medication.name}),t&&e.jsxs("div",{className:"mt-1 flex items-center gap-1 text-sm text-red-600",children:[e.jsx(p,{className:"h-3 w-3"}),"Contains allergen"]})]}),e.jsx(l,{children:s.instructions||"No instructions"}),e.jsx(l,{children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("span",{className:"font-medium",children:s.quantity})})}),e.jsx(l,{children:e.jsx(m,{variant:s.repeats_remaining>0?"default":"destructive",children:s.repeats_remaining})}),e.jsx(l,{children:e.jsx(m,{variant:s.medication.quantity_on_hand>=o?"default":"destructive",children:s.medication.quantity_on_hand})}),e.jsxs(l,{children:["R",k.toFixed(2)]}),e.jsxs(l,{children:["R",U.toFixed(2)]}),e.jsx(l,{children:e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t&&e.jsx("span",{className:"inline-flex items-center gap-1",children:e.jsxs(m,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(p,{className:"h-3 w-3"})," Allergic"]})}),!t&&s.repeats_remaining===0&&e.jsx(m,{variant:"secondary",children:"No Repeats"}),!t&&s.repeats_remaining>0&&s.medication.quantity_on_hand<o&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(m,{variant:"destructive",children:"Low Stock"}),e.jsx(P,{href:`/pharmacist/stock?medication=${s.medication_id}`,className:"text-muted-foreground hover:text-foreground",title:"View / Restock",children:e.jsx(le,{className:"h-4 w-4"})})]}),i&&e.jsx(m,{variant:"default",children:"Ready"})]})})]},s.id)})})]})}),e.jsx("div",{className:"bg-muted mt-6 rounded-none p-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Selected Items: ",a.length]}),e.jsxs("p",{className:"text-lg font-semibold",children:["Total Cost: R",B().toFixed(2)]})]})})}),e.jsxs("div",{className:"mt-6",children:[e.jsx(c,{htmlFor:"notes",children:"Dispensing Notes (Optional)"}),e.jsx(se,{id:"notes",placeholder:"Add any notes about the dispensing process...",value:h.notes,onChange:s=>u("notes",s.target.value),className:"mt-2"})]}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx(j,{onClick:E,disabled:f||a.length===0,size:"lg",children:f?"Dispensing...":`Dispense Selected Items (${a.length})`}),e.jsx(j,{variant:"outline",size:"lg",asChild:!0,children:e.jsx(P,{href:route("pharmacist.prescriptions.dispense"),children:"Cancel"})})]}),v&&Object.keys(v).length>0&&e.jsxs(y,{className:"mt-4 border-red-200 bg-red-50",children:[e.jsx(p,{className:"h-4 w-4 text-red-600"}),e.jsxs(_,{className:"text-red-800",children:[e.jsx("strong",{children:"Please fix the following errors:"}),e.jsx("ul",{className:"mt-2 list-inside list-disc",children:Object.entries(v).map(([s,t])=>e.jsx("li",{children:t},s))})]})]})]})]})]})]})}export{Ce as default};
